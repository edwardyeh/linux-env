#! /bin/bash

# ------------------------------------------------------------
# --- Command Check
# ------------------------------------------------------------

function usage() {
    prog=$(basename $0)
    echo "Usage: $prog <format> <filename> [force_replace]"
    header_gen -list

    echo "  force_replace: y  -- force replace    "
    echo "                 n  -- process terminate"
    echo ""
}

if [ "$#" -lt 2 -o "$#" -gt 3 ]; then
    usage $0
    exit 1
fi

header_gen $1 $2 -test

if [ "$?" -ne 0 ]; then 
    usage $0 
    exit 1 
fi

if [ -f "$2" ]; then
    ans=

    if [ "$#" -eq 3 ]; then
        ans="$3"
    else
        read -p "File exist, replace? (y/n) " ans
    fi

    if [ "$ans" == "Y" -o "$ans" == "y" ]; then
        \rm -rf $2
    else
        echo "Process terminate"
        exit
    fi
fi

# ------------------------------------------------------------
# --- Pre-Process
# ------------------------------------------------------------
if [ "$1" == "bs" ]; then
    echo '#!/bin/bash' > $2
    header_gen $1 $2 >> $2
    echo '' >> $2
    echo 'alias acalc='"'"'function func { awk "BEGIN{ print $* }"; }; func'"'" >> $2
    echo '' >> $2
    chmod +x $2
elif [ "$1" == "cs" ]; then
    echo '#!/bin/csh' > $2
    header_gen $1 $2 >> $2
    echo '' >> $2
    echo 'alias acalc '"'"'awk "BEGIN{ print \!* }"'"'" >> $2
    echo 'alias "bash -c '"'"'echo "'"'"'$RANDOM'"'"'"'"'"'"' >> $2
    echo '' >> $2
    chmod +x $2
elif [ "$1" == "py" ]; then
    echo '#!/usr/bin/env python3'   > $2
    echo '# -*- coding: utf-8 -*-' >> $2
    header_gen $1 $2 >> $2
    echo '' >> $2
    chmod +x $2
else
    header_gen $1 $2 >> $2
    echo '' >> $2
fi

# ------------------------------------------------------------
# --- Post-Process
# ------------------------------------------------------------

if [ "$1" == "v" ]; then
    org=""
    module_name=$(echo $2 | sed 's/\.v//g')

    echo "module $module_name ();"                                        >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Parameter'                                                >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Input'                                                    >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Output'                                                   >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo "//${org}ss_protect"                                             >> $2
    echo '//============================================================' >> $2
    echo '//--- Register'                                                 >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Wire'                                                     >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Circuit'                                                  >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo "//${org}ss_endprotect"                                          >> $2
    echo ''                                                               >> $2
    echo 'endmodule'                                                      >> $2

elif [ "$1" == "t" ]; then
    module_name=$(echo $2 | sed 's/\.v//g')

    echo "moudle $module_name;"                                           >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Parameter'                                                >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Signal'                                                   >> $2
    echo '//============================================================' >> $2
    echo '//{{{'                                                          >> $2
    echo '//}}}'                                                          >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Description'                                              >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Task'                                                     >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Circuit'                                                  >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Monitor'                                                  >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Waveform Dump'                                            >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo 'endmodule'                                                      >> $2

elif [ "$1" == "f" ]; then
    echo '//============================================================' >> $2
    echo '//--- Include Path'                                             >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Define'                                                   >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Library'                                                  >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- DesignWare'                                               >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Testbench'                                                >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Monitor'                                                  >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2
    echo '//============================================================' >> $2
    echo '//--- Design'                                                   >> $2
    echo '//============================================================' >> $2
    echo ''                                                               >> $2

fi
        
